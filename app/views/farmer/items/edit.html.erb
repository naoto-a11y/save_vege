<div class="container white-bg p-5">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <h2 class="text-center mb-4">å•†å“æƒ…å ±ã‚’ç·¨é›†</h2>

      <%= form_with model: @item, url: farmer_item_path(@item), method: :patch, local: true, html: { multipart: true } do |f| %>

        <div class="form-group row mb-2">
          <label class="col-sm-3 col-form-label text-sm-right"><%= f.label :name, "å•†å“å", class: "form-label" %></label>
          <div class="col-sm-9"><%= f.text_field :name, class: "form-control", placeholder: "ä¾‹ï¼šæœæ¡ã‚Œãƒˆãƒãƒˆ 1kg" %></div>
        </div>

        <div class="form-group row mb-2">
          <label class="col-sm-3 col-form-label text-sm-right"><%= f.label :image, "å•†å“ç”»åƒ", class: "form-label" %></label>
          <div class="col-sm-9">
            <% if @item.image.attached? %>
              <div class="mb-2">
                <%= image_tag @item.get_image, style: "width: 450px; height: 350px;" %>
              </div>
            <% end %>
            <%= f.file_field :image, class: "form-control-file" %>
          </div>
        </div>

        <div class="form-group row mb-2">
          <label class="col-sm-3 col-form-label text-sm-right"><%= f.label :price, "å€¤æ®µï¼ˆå††ï¼‰", class: "form-label" %></label>
          <div class="col-sm-9"><%= f.number_field :price, class: "form-control", min: 0 %></div>
        </div>

        <div class="form-group row mb-2">
          <label class="col-sm-3 col-form-label text-sm-right"><%= f.label :introduction, "ç´¹ä»‹æ–‡", class: "form-label" %></label>
          <div class="col-sm-9"><%= f.text_area :introduction, rows: 4, class: "form-control", placeholder: "å•†å“ã«ã¤ã„ã¦ã®èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" %></div>
        </div>

        <div class="form-group row mb-2">
          <label class="col-sm-3 col-form-label text-sm-right"><%= f.label :harvest_date, "åç©«æ—¥", class: "form-label" %></label>
          <div class="col-sm-9"><%= f.date_field :harvest_date, class: "form-control" %></div>
        </div>

        <div class="form-group row mb-2">
          <label class="col-sm-3 col-form-label text-sm-right"><%= f.label :category_id, "ã‚«ãƒ†ã‚´ãƒª" %></label>
          <div class="col-sm-9"><%= f.collection_select :category_id, Category.all, :id, :name, prompt: "ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ", class: "form-control " %></div>
        </div>

        <div class="form-group row mb-2">
          <label class="col-sm-3 col-form-label text-sm-right"><span>ã‚¿ã‚°</span></label>
          <% Tag.all.each do |tag| %>
            <label class="btn btn-outline-dark btn-sm m-1 ml-3">
              <%= check_box_tag "item[tag_ids][]", tag.id, @item.tags.include?(tag), style: "margin-right: 6px;" %>
              <%= tag.tag_name %>
            </label>
          <% end %>
        </div>

        <div class="form-group row mb-2">
          <label class="col-sm-3 col-form-label text-sm-right"><%= label_tag :new_tag_names, "æ–°è¦ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰", class: "form-label" %></label>
          <div class="col-sm-9"><%= text_field_tag "item[tag_names]", "", class: "form-control", placeholder: "ä¾‹ï¼šæ˜¥é‡èœ,æœ‰æ©Ÿæ ½åŸ¹" %></div>
        </div>

        <div id="available-slots">
          <%= f.fields_for :available_slots do |slot_f| %>
            <div class="available-slot mb-3">
              <div class="row">
                <div class="col-sm-3 col-form-label text-sm-right">
                  <%= slot_f.label :available_date, "å—æ¸¡å¯èƒ½æ—¥" %>
                </div>
                <div class="col-sm-9">
                  <%= slot_f.date_field :available_date, class: "form-control form-control-sm" %>
                </div>
              </div>

              <div class="text-right">
                <button type="button" class="btn btn-danger btn-sm remove-slot">ğŸ—‘</button>
              </div>
            </div>
          <% end %>
        </div>

        <div class="text-right">
          <button type="button" class="btn btn-outline-success mb-3" id="add-slot">ï¼‹ æ™‚é–“å¸¯ã‚’è¿½åŠ </button>   
        </div>


        <div class="text-center mt-5">
          <%= f.submit "æ›´æ–°ã™ã‚‹", class: "btn btn-success px-5" %>
          <%= link_to "æˆ»ã‚‹", farmer_item_path(@item), class: "btn btn-secondary px-4 ms-3" %>
        </div>
      <% end %>
    </div>

    <template id="slot-template">
  <div class="available-slot mb-3">
    <div class="row">
      <div class="col-sm-3 col-form-label text-sm-right">
        <label for="">å—æ¸¡å¯èƒ½æ—¥</label>
      </div>
      <div class="col-sm-9">
        <input type="date"
               name="item[available_slots_attributes][0][available_date]"
               id="item_available_slots_attributes_0_available_date"
               class="form-control form-control-sm">
      </div>
    </div>

    <div class="text-right">
      <button type="button" class="btn btn-danger btn-sm remove-slot">ğŸ—‘</button>
    </div>
  </div>
</template>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const addBtn = document.getElementById("add-slot");
    const container = document.getElementById("available-slots");
    const template = document.getElementById("slot-template").innerHTML;

    // ãƒ•ã‚©ãƒ¼ãƒ è¿½åŠ 
    addBtn.addEventListener("click", () => {
      const currentCount = container.querySelectorAll(".available-slot").length;
      if (currentCount >= 10) {
        alert("ã“ã‚Œä»¥ä¸Šã¯è¿½åŠ ã§ãã¾ã›ã‚“");
        return;
      }

      const newIndex = Date.now();
      const newField = template.replace(/\[available_slots_attributes\]\[\d*\]/g, `[available_slots_attributes][${newIndex}]`)
                              .replace(/_available_slots_attributes_\d*_/g, `_available_slots_attributes_${newIndex}_`);

      container.insertAdjacentHTML("beforeend", newField);
    });

    // ãƒ•ã‚©ãƒ¼ãƒ å‰Šé™¤
    container.addEventListener("click", function (e) {
      if (e.target.classList.contains("remove-slot")) {
        const slots = container.querySelectorAll(".available-slot");
        if (slots.length <= 1) {
          alert("æœ€ä½1ä»¶ã¯å¿…è¦ã§ã™");
          return;
        }
        e.target.closest(".available-slot").remove();
      }
    });
  });
</script>