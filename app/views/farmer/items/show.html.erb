<div class="container-fluid px-5 mx-5 my-4">
  <div class="row">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šå·¦ -->
    <div class="col-3">
      <%= render 'share/info', farmer: @farmer %>
      <%= link_to farmer_reservations_path, class: "btn btn-outline-dark w-100 my-2" do %>
        äºˆç´„ä¸€è¦§ï¼ˆ<%= @reservation_count %>ï¼‰
      <% end %>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼šå³ -->
    <div class="col-8 px-5 mx-3">
      <div class="card shadow-sm p-4 mb-4 w-100">
        <div class="container">
          <div class="row">
            <!-- å·¦ä¸Šï¼šç”»åƒ -->
            <div class="col-6 d-flex justify-content-center align-items-center mb-4">
              <%= image_tag @item.get_image, class: "img-fluid rounded", style: "width: 400px; height: 400px; object-fit: cover;" %>
            </div>
      
            <!-- å³ä¸Šï¼šå•†å“æƒ…å ± -->
            <div class="col-6 d-flex justify-content-center align-items-center mb-4">
              <div>
                <h1 class="mb-3 fw-bold"><%= @item.name %></h1>
                <p class="text-muted fs-5 mb-2">ç”Ÿç”£è€…ï¼š<strong><%= @item.farmer.last_name %>ã•ã‚“</strong></p>
                <p class="fs-5 mb-3"><%= @item.introduction %></p>
                <p class="h4 text-success mb-3">ï¿¥<%= number_with_delimiter(@item.price) %>ï¼ˆç¨è¾¼ï¼‰</p>
                <p class="fs-5 text-danger mb-3">â¤ï¸ <%= @item.favorites.count %> ã„ã„ã­</p>
                <p>
                  <% @item.tags.each do |tag| %>
                    ğŸ”–<%= tag.tag_name %>
                  <% end %>
                </p><br>
                <%= link_to "å•†å“æƒ…å ±ã‚’ç·¨é›†", edit_farmer_item_path(@item), class: "btn btn-outline-primary mt-2" %>
                <%= link_to "å•†å“ã‚’å‰Šé™¤", farmer_item_path(@item), method: :delete, data: { confirm: "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ" }, class: "btn btn-outline-danger mt-2" %>
                <% if @item.is_active %>
                  <%= link_to "å•†å“æƒ…å ±ã‚’éå…¬é–‹ã«ã™ã‚‹", farmer_deactivate_farmer_item_path(@item), method: :patch, data: { confirm: "æœ¬å½“ã«ã“ã®å•†å“ã‚’éå…¬é–‹ã«ã—ã¾ã™ã‹ï¼Ÿ" }, class: "btn btn-outline-dark mt-2" %>
                <% else %>
                  <%= link_to "å•†å“æƒ…å ±ã‚’å…¬é–‹ã™ã‚‹", farmer_activate_farmer_item_path(@item), method: :patch, data: { confirm: "æœ¬å½“ã«ã“ã®å•†å“ã‚’å…¬é–‹ã—ã¾ã™ã‹ï¼Ÿ" }, class: "btn btn-outline-success mt-2" %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
    
        <div class="row">
          <!-- å·¦ä¸‹ï¼šåœ°å›³ -->
          <div class="col-6 d-flex flex-column justify-content-center align-items-center">
            <% if @item.farmer.latitude && @item.farmer.longitude %>
              <h5 class="mb-3">è²©å£²å…ˆ</h5>
          
              <div id="map" class="border border-secondary rounded shadow-sm" style="width: 500px; height: 400px;"></div>
          
              <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAP_API_KEY'] %>&callback=initMap" async defer></script>
              <script>
                function initMap() {
                  const location = { lat: <%= @item.farmer.latitude %>, lng: <%= @item.farmer.longitude %> };
                  const map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 15,
                    center: location,
                  });
                  new google.maps.Marker({
                    position: location,
                    map: map,
                    title: "<%= j @item.farmer.seller_address %>"
                  });
                }
              </script>
            <% else %>
              <h5 class="mb-2">è²©å£²å…ˆ</h5>
              <p class="text-muted">â€»åœ°å›³æƒ…å ±ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
              <p>è²©å£²å…ˆä½æ‰€ï¼š<%= @item.farmer.seller_address %></p>
            <% end %>
          </div>
    
          <!-- å³ä¸‹ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
          <div class="col-6 d-flex justify-content-center align-items-center">
            <div class="w-100">
              <h5 class="text-center mb-3">å—å–å¯èƒ½æ—¥</h5>
              <div id="calendar" class="border rounded shadow-sm p-2" style="max-width: 500px;"></div>
            </div>
          </div>

          <!-- FullCalendar CDN èª­ã¿è¾¼ã¿ -->
          <%= javascript_include_tag "https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js" %>
          <%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" %>
        </div>
      </div>
      <!-- ã‚³ãƒ¡ãƒ³ãƒˆ -->
      <%= render 'public/comments/index', comments: @comments, item: @item, comment: @comment %>
    </div>
  </div>
</div>

<script>
  document.addEventListener("turbolinks:load", function () {
    const calendarEl = document.getElementById("calendar");

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      height: 400,
      events: [
        <% events = [] %>

        <% if @item.harvest_date.present? %>
          <% events << {
            title: "åç©«æ—¥",
            start: @item.harvest_date.strftime('%Y-%m-%d'),
            color: "#198754"
          } %>
        <% end %>

        <% @item.available_slots.each do |slot| %>
          <% if slot.available_date.present? %>
            <% events << {
              title: "å—å–å¯èƒ½æ—¥",
              start: slot.available_date.strftime('%Y-%m-%d'),
              color: "#0dcaf0"
            } %>
          <% end %>
        <% end %>

        <%= raw events.map { |event| event.to_json }.join(",\n") %>
      ]
    });

    calendar.render();
  });
</script>
