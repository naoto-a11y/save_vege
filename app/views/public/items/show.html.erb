<div class="container-fluid px-5 mx-5 my-4">
  <div class="row">
    <!-- „Çµ„Ç§„Éâ„Éê„ÉºÔºöÂ∑¶ -->
    <div class="col-3">
      <% if customer_signed_in? %>
        <%= render 'share/info', customer: @customer %>
        <%= link_to reservations_path, class: "btn btn-outline-dark w-100 my-2" do %>
          ‰∫àÁ¥Ñ‰∏ÄË¶ß(<%= @reservations.count %>)
        <% end %>
      <% end %>
      <%= render 'public/tags/tag', tags: @tags %>
    </div>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºöÂè≥ -->
    <div class="col-8 px-5 mx-3">
      <div class="card shadow-sm p-4 mb-4 w-100">
        <div class="container">
          <div class="row">
            <!-- Â∑¶‰∏äÔºöÁîªÂÉè -->
            <div class="col-6 d-flex justify-content-center align-items-center mb-4">
              <%= image_tag @item.get_image, class: "img-fluid rounded", style: "width: 400px; height: 400px; object-fit: cover;" %>
            </div>
      
            <!-- Âè≥‰∏äÔºöÂïÜÂìÅÊÉÖÂ†± -->
            <div class="col-6 d-flex justify-content-center align-items-center mb-4">
              <div>
              <h1 class="mb-3 fw-bold"><%= @item.name %></h1>
              <p class="fs-5 mb-3"><%= @item.introduction %></p>
              <p class="h4 text-success mb-3">Ôø•<%= number_with_delimiter(@item.price) %>ÔºàÁ®éËæºÔºâ</p>
              <p class="fs-5 text-danger mb-3">
                <% if customer_signed_in? %>
                  <% if current_customer.favorited?(@item) %>
                    <% favorite = current_customer.favorite_for(@item) %>
                    <%= link_to "‚ù§Ô∏è #{@item.favorites.count}", favorite_path(@item.id), method: :delete %>
                  <% else %>
                    <%= link_to "‚ô° #{@item.favorites.count}", favorites_path(item_id: @item.id), method: :post %>
                  <% end %>
                <% else %>
                  ‚ù§Ô∏è<%= @item.favorites.count %>
                <% end %>
              </p>
              <p>
                <% @item.tags.each do |tag| %>
                  üîñ<%= tag.tag_name %>
                <% end %>
              </p><br>
              <% if customer_signed_in? %>
                <% if current_customer.reserved_item?(@item) %>
                  <%= link_to "DM„Åô„Çã",dm_room_path(@reservation.dm_room.id), class: "btn btn-outline-primary" %><br>
                <% else %>
                  <%= form_with model: @reservation, url: item_reservations_path(@item), method: :post, local: true do |f| %>
                    <div class="mb-3">
                    <%= f.label :reserved_date, "‰∫àÁ¥ÑÊó•„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ", class: "form-label" %>
                    <%= f.select :reserved_date, 
                          @item.available_slots.map { |date| [date.available_date.strftime('%Y/%m/%d'), date.available_date] },
                          { prompt: "ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ" },
                          class: "form-select" %>
                    </div>
                    <%= f.submit "‰∫àÁ¥Ñ„Åô„Çã", class: "btn btn-outline-dark" %>
                  <% end %>
                <% end %>
              <% end %>
              ÁîüÁî£ËÄÖÔºö<%= link_to farmer_path(@item.farmer) do %>
                <%= @item.farmer.last_name %>
              <% end %>„Åï„Çì
              
              <% if customer_signed_in? %>
                <% unless current_customer.following?(@item.farmer) %>
                  <%= link_to "„Éï„Ç©„É≠„Éº„Åô„Çã", farmer_follow_path(@item.farmer.id), method: :post, class: "btn btn-outline-dark ml-3" %>
                <% else %>
                  <%= link_to "„Éï„Ç©„É≠„ÉºËß£Èô§", farmer_follow_path(@item.farmer.id,), method: :delete, class: "btn btn-outline-dark ml-3" %>
                <% end %>
              <% end %>
              </div>
            </div>
          </div>
        </div>
    
        <div class="row">
          <!-- Â∑¶‰∏ãÔºöÂú∞Âõ≥ -->
          <div class="col-6 d-flex flex-column justify-content-center align-items-center">
            <% if @item.farmer.latitude && @item.farmer.longitude %>
              <h5 class="mb-3">Ë≤©Â£≤ÂÖà</h5>
          
              <div id="map" class="border border-secondary rounded shadow-sm" style="width: 500px; height: 400px;"></div>
          
              <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAP_API_KEY'] %>&callback=initMap" async defer></script>
              <script>
                function initMap() {
                  const location = { lat: <%= @item.farmer.latitude %>, lng: <%= @item.farmer.longitude %> };
                  const map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 15,
                    center: location,
                  });
                  new google.maps.Marker({
                    position: location,
                    map: map,
                    title: "<%= j @item.farmer.seller_address %>"
                  });
                }
              </script>
            <% else %>
              <h5 class="mb-2">Ë≤©Â£≤ÂÖà</h5>
              <p class="text-muted">‚ÄªÂú∞Âõ≥ÊÉÖÂ†±„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
              <p>Ë≤©Â£≤ÂÖà‰ΩèÊâÄÔºö<%= @item.farmer.seller_address %></p>
            <% end %>
          </div>
    
          <!-- Âè≥‰∏ãÔºö„Ç´„É¨„É≥„ÉÄ„Éº -->
          <div class="col-6 d-flex justify-content-center align-items-center">
            <div class="w-100">
              <h5 class="text-center mb-3">ÂèóÂèñÂèØËÉΩÊó•</h5>
              <div id="calendar" class="border rounded shadow-sm p-2" style="max-width: 500px;"></div>
            </div>
          </div>

          <!-- FullCalendar CDN Ë™≠„ÅøËæº„Åø -->
          <%= javascript_include_tag "https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js" %>
          <%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" %>
          
        </div>
      </div>
      <!-- „Ç≥„É°„É≥„Éà -->
      <%= render 'public/comments/index', comments: @comments, item: @item, comment: @comment %>
    </div>
  </div>
</div>

<script>
  document.addEventListener("turbolinks:load", function () {
    const calendarEl = document.getElementById("calendar");

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      height: 400,
      events: [
        <% events = [] %>

        <% if @item.harvest_date.present? %>
          <% events << {
            title: "ÂèéÁ©´Êó•",
            start: @item.harvest_date.strftime('%Y-%m-%d'),
            color: "#198754"
          } %>
        <% end %>

        <% @item.available_slots.each do |slot| %>
          <% if slot.available_date.present? %>
            <% events << {
              title: "ÂèóÂèñÂèØËÉΩÊó•",
              start: slot.available_date.strftime('%Y-%m-%d'),
              color: "#0dcaf0"
            } %>
          <% end %>
        <% end %>

        <%= raw events.map { |event| event.to_json }.join(",\n") %>
      ]
    });

    calendar.render();
  });
</script>

