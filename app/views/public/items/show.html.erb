<div class="container-fluid px-5 mx-5 my-4">
  <div class="row">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šå·¦ -->
    <div class="col-3">
      <% if customer_signed_in? %>
        <%= render 'share/info', customer: @customer %>
        <%= link_to reservations_path, class: "btn btn-outline-dark w-100 my-2" do %>
          äºˆç´„ä¸€è¦§(<%= @reservations.count %>)
        <% end %>
      <% end %>
      <%= render 'public/tags/tag', tags: @tags %>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼šå³ -->
    <div class="col-8 px-5 mx-3">
      <div class="card shadow-sm p-4 mb-4 w-100">
        <div class="d-flex justify-content-between">
          <!-- å·¦ï¼šç”»åƒ -->
          <div class="ml-5 pl-5">
            <%= image_tag @item.get_image, class: "img-fluid rounded mb-3", style: "width: 450px; height: 350px; object-fit: cover;" %>
            <h5 class="mt-4">è²©å£²å…ˆ</h5>
            <!-- åœ°å›³è¡¨ç¤º -->
            <% if @item.farmer.latitude && @item.farmer.longitude %>
              <div id="map" style="width: 400px; height: 400px;" class="mt-3"></div>
              <script>
                document.addEventListener("DOMContentLoaded", function () {
                  const lat = <%= @item.farmer.latitude %>;
                  const lng = <%= @item.farmer.longitude %>;

                  const map = L.map('map').setView([lat, lng], 15);
                  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                  }).addTo(map);

                  L.marker([lat, lng]).addTo(map)
                    .bindPopup("<%= j @item.farmer.address %>")  // â†ä½æ‰€ã‚‚farmerã®ã‚‚ã®ã‚’è¡¨ç¤º
                    .openPopup();
                });
              </script>
            <% else %>
              <p class="text-muted">â€»åœ°å›³æƒ…å ±ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
              <p>è²©å£²å…ˆä½æ‰€ï¼š<%= @item.farmer.seller_address %></p>
            <% end %>
          </div>

          <!-- å³ï¼šå•†å“æƒ…å ± -->
          <!-- å³ç«¯ã«å•†å“æƒ…å ± -->
          <div class="mr-5 pr-5">
            <h1 class="mb-3 fw-bold"><%= @item.name %></h1>
            <p class="fs-5 mb-3"><%= @item.introduction %></p>
            <p class="h4 text-success mb-3">ï¿¥<%= number_with_delimiter(@item.price) %>ï¼ˆç¨è¾¼ï¼‰</p>
            <p class="fs-5 text-danger mb-3">
              <% if customer_signed_in? %>
                <% if current_customer.favorited?(@item) %>
                  <% favorite = current_customer.favorite_for(@item) %>
                  <%= link_to "â¤ï¸ #{@item.favorites.count}", favorite_path(@item.id), method: :delete %>
                <% else %>
                  <%= link_to "â™¡ #{@item.favorites.count}", favorites_path(item_id: @item.id), method: :post %>
                <% end %>
              <% else %>
                â¤ï¸<%= @item.favorites.count %>
              <% end %>
            </p>
            <p>
              <% @item.tags.each do |tag| %>
                ğŸ”–<%= tag.tag_name %>
              <% end %>
            </p><br>
            <% if customer_signed_in? %>
              <% if current_customer.reserved_item?(@item) %>
                <%= link_to "DMã™ã‚‹",dm_room_path(@reservation.dm_room.id), class: "btn btn-outline-primary" %><br>
              <% else %>
                <%= form_with model: @reservation, url: item_reservations_path(@item), method: :post, local: true do |f| %>
                  <div class="mb-3">
                  <%= f.label :reserved_date, "äºˆç´„æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„", class: "form-label" %>
                  <%= f.select :reserved_date, 
                        @item.available_slots.map { |date| [date.available_date.strftime('%Y/%m/%d'), date.available_date] },
                        { prompt: "é¸æŠã—ã¦ãã ã•ã„" },
                        class: "form-select" %>
                  </div>
                  <%= f.submit "äºˆç´„ã™ã‚‹", class: "btn btn-outline-dark" %>
                <% end %>
              <% end %>
            <% end %>
            ç”Ÿç”£è€…ï¼š<%= link_to farmer_path(@item.farmer) do %>
              <%= @item.farmer.last_name %>
            <% end %>ã•ã‚“
            
            <% if customer_signed_in? %>
              <% unless current_customer.following?(@item.farmer) %>
                <%= link_to "ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹", farmer_follow_path(@item.farmer.id), method: :post, class: "btn btn-outline-dark ml-3" %>
              <% else %>
                <%= link_to "ãƒ•ã‚©ãƒ­ãƒ¼è§£é™¤", farmer_follow_path(@item.farmer.id,), method: :delete, class: "btn btn-outline-dark ml-3" %>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
      <%= render 'public/comments/index', comments: @comments, item: @item, comment: @comment %>
    </div>
  </div>
</div>


